<!-- 
#################################################
# HEAD - FOR ALL PAGES
#################################################
 --><!doctype html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name="author" content="Martin Alfaro"><script>function applySavedTheme(){"enabled"===localStorage.getItem("darkMode")&&document.documentElement.classList.add("dark-mode")}applySavedTheme()</script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Cormorant+SC:wght@300;400;600;700&family=Inter:wght@300..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet"><link rel="stylesheet" href="/julia_book/libs/katex/katex.min.css"><link rel="stylesheet" href="/julia_book/libs/highlight/styles/vs_myversion.css"><link rel="stylesheet" href="/julia_book/css/bootstrap.min.css"><style>.section-bg-color{background-color:rgba(63,99,136,.07)}footer a{color:#6495ed}header{margin-top:0!important}header .jumbotron{background-image:linear-gradient(to right,#000,#000 10%,#3f6388 55%,#3f6388);background-repeat:no-repeat;background-size:100%}</style><link rel="stylesheet" href="/julia_book/css/custom.css"><title>9g. Lazy Broadcasting and Loop Fusion - Julia Book - Martin Alfaro</title><link rel="icon" type="image/png" href="/julia_book/assets/icons/favicon.ico"></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-K96JNP7PKB"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-K96JNP7PKB")</script><body id="page-top"><!-- 
#################################################
# FOR EACH SPECIFIC PAGE
#################################################
 --><style>html{scroll-behavior:auto}.bar_top,.jumbotron,.left_bar,.nav-item,.navbar,footer{font-size:16px;font-family:"Open Sans"}.franklin-content{font-size:17px;font-family:"Open Sans"}h1{font-family:Inter,"Open Sans";font-weight:600}h1{padding-top:.1em;font-size:210%!important;font-weight:700;text-align:center}.phd_format{color:#fff;text-decoration:none;font-size:90%;text-align:center;margin-top:-.2em;margin-bottom:-.89em}.name_format{padding-top:.35em;text-decoration:none;font-size:160%}.name_format a{color:#fff}.name_format a:hover{color:#d4d4d4;color:#d6e3f0}.franklin-content{background-color:#d9e0e7}.franklin-content{margin:0;width:100%;height:100%;justify-content:center;text-align:justify;text-justify:inter-word;line-height:1.65}.jumbotron{margin-bottom:0;padding-top:42px;padding-bottom:2em;border-bottom:#000 solid 1px;border-radius:0}.franklin-content,.jumbotron{padding-left:160px}footer{background-image:linear-gradient(to right,#23374b,#000 50%,#3f6388);background-color:#3f6388;width:calc(100%+10px);margin-left:-10px;padding-left:10px}h2{text-transform:uppercase;font-size:160%;text-align:center;text-decoration:underline;padding-bottom:.5em;font-weight:700}h3{text-align:left;text-transform:uppercase;text-decoration:underline;padding-bottom:0;padding-top:.5em;font-size:120%;font-weight:600}h4 a{font-weight:800!important}h4{text-align:left;color:#3a6c9e;text-decoration:underline;padding-bottom:0;padding-top:.5em;font-weight:800!important;text-transform:uppercase;font-size:120%}h5,h6{text-indent:0;line-height:1.2em;padding-top:.99em;padding-bottom:-0em}section{margin-left:0;padding-left:1%;padding-right:1%;padding-top:1.5%;padding-bottom:1%;text-align:justify;text-justify:inter-word;line-height:1.65;text-indent:0;font-size:100%;color:#000}section h1{text-indent:0;margin-left:0}section h2{text-indent:0;margin-bottom:0}.franklin-content ul{margin-left:0;margin-top:-.6em;line-height:1.15}.franklin-content ul li p{margin-left:0;margin-bottom:.6em;line-height:1.35;text-indent:0}.franklin-content ol li{margin-left:2em;line-height:1.15}ul ::marker{color:#49739d}ol ::marker{color:#5381af;font-weight:700}a.anchor{display:block;position:relative;top:-150px;visibility:hidden}section a{color:#3e79b4;text-decoration:underline;font-weight:500}section a:hover{color:rgba(62,121,180,.699);text-decoration:underline}</style><style>:target{scroll-margin-top:40px}.own-anchors a{scroll-margin-top:4em}</style><div class="left_bar" style="color:#fff"><span><img src="/julia_book/assets/pics_html/julia_logo-dark.svg" alt="pic" style="padding:12px;padding-right:28px;padding-top:44px" width="160px" height="auto"></span><link href="/julia_book/pagefind/pagefind-ui.css" rel="stylesheet"><script src="/julia_book/pagefind/pagefind-ui.js"></script><ul><li style="text-transform:uppercase"><a href="/julia_book/index.html"><img src="/julia_book/assets/icons/home.png" style="width:15%;height:auto;opacity:.9;padding-bottom:5px"> Home</a></li><li style="text-transform:uppercase"><a href="/julia_book/list_posts/"><img src="/julia_book/assets/icons/books03.png" style="width:15%;height:auto;opacity:.9;padding-bottom:5px"> Chapters</a></li><li><div style="text-indent:0"><button class="modalButton" style="text-transform:uppercase"><img src="/julia_book/assets/icons/keyboard01.png" style="width:20%;height:auto;opacity:.9;margin-bottom:-26px;margin-left:-30px;padding-right:4px"> <span style="margin-left:-.2em">Notation &<div style="margin-left:-1.2em;margin-top:-3em">Hotkeys</div></span></button><div class="kbd_shortcuts"><div class="modal" id="kbdmodal_bar"><div class="modal-content"><div class="modal-header"><h2>NOTATION</h2></div><div class="modal-body" style="height:auto">Generic expressions are represented by <b>&lt;something&gt;</b> (e.g., <code>&lt;function&gt;</code> or <code>&lt;operator&gt;</code>). This is just notation, and the symbols <code>&lt;</code> and <code>&gt;</code> should not be misconstrued as Julia's syntax.</div><div class="modal-header"><h2>PAGE LAYOUT</h2></div><div class="modal-body">If you want to adjust the size of the font, <b>zoom in or out on pages</b> by respectively using <kbd>Ctrl</kbd>+<kbd>+</kbd> and <kbd>Ctrl</kbd>+<kbd>-</kbd>. The layout will adjust automatically.<br><span class="brmine"></span></div><div class="modal-header"><h2>LINKS TO SECTIONS</h2></div><div class="modal-body">To quickly share a link to a specific section, simply hover over the title and click on it. The link will be automatically copied to your clipboard, ready to be pasted. <span class="brmine"></span></div><div class="modal-header"><h2>KEYBOARD SHORTCUTS</h2></div><div class="modal-body"><style type="text/css">.tg{border-collapse:collapse;border-spacing:0}.tg td{border-color:#000;border-style:solid;border-width:1px;overflow:hidden;padding:10px 12px;word-break:normal}.tg th{border-color:#000;border-style:solid;border-width:1px;font-weight:400;overflow:hidden;padding:10px 5px;word-break:normal}.tg .tg-80zn{background-color:rgba(63,99,136,.2);border-color:#fff;font-weight:700;text-align:center;vertical-align:top}.tg .tg-esg4{background-color:#ebebeb;border-color:#fff;font-weight:700;text-align:right;vertical-align:top}.tg .tg-8jgo{border-color:#fff;text-align:left;vertical-align:top}.tg .tg-ofj5{border-color:#fff;text-align:center;vertical-align:top}</style><table class="tg" style="margin-left:auto;margin-right:auto"><thead><tr><th class="tg-80zn">Action</th><th class="tg-80zn">Keyboard Shortcut</th></tr></thead><tbody><tr><td class="tg-8jgo">Previous Section</td><td class="tg-ofj5"><kbd>Ctrl + ðŸ ˜</kbd></td></tr><tr><td class="tg-8jgo">Next Section</td><td class="tg-ofj5"><kbd>Ctrl + ðŸ š</kbd></td></tr><tr><td class="tg-8jgo">List of Subsections</td><td class="tg-ofj5"><kbd>Ctrl + x</kbd></td></tr><tr><td class="tg-8jgo">Close Any Popped Up Window (like this one)</td><td class="tg-ofj5"><kbd>Esc</kbd></td></tr><tr><td class="tg-8jgo">Open All Codes and Outputs in a Post</td><td class="tg-ofj5"><kbd>Alt + ðŸ ›</kbd></td></tr><tr><td class="tg-8jgo">Close All Codes and Outputs in a Post</td><td class="tg-ofj5"><kbd>Alt + ðŸ ™</kbd></td></tr></tbody></table><span class="brmine"></span></div><div class="modal-header"><h2>TIME MEASUREMENT</h2></div><div class="modal-body">When benchmarking, the equivalence of time measures is as follows.<br><br><style type="text/css">.tg{border-collapse:collapse;border-spacing:0}.tg td{border-color:#000;border-style:solid;border-width:1px;overflow:hidden;padding:10px 5px;word-break:normal}.tg th{border-color:#000;border-style:solid;border-width:1px;font-weight:400;overflow:hidden;padding:10px 5px;word-break:normal}.tg .tg-80zn{background-color:#ebebeb;border-color:#fff;font-weight:700;text-align:left;vertical-align:top}.tg .tg-esg4{background-color:#ebebeb;border-color:#fff;font-weight:700;text-align:right;vertical-align:top}.tg .tg-8jgo{border-color:#fff;text-align:left;vertical-align:top}.tg .tg-ofj5{border-color:#fff;text-align:center;vertical-align:top}</style><table class="tg" style="margin-left:auto;margin-right:auto"><thead><tr><th class="tg-80zn">Unit</th><th class="tg-80zn">Acronym</th><th class="tg-80zn">Measure in Seconds</th></tr></thead><tbody><tr><td class="tg-8jgo">Seconds</td><td class="tg-ofj5">s</td><td class="tg-ofj5">1</td></tr><tr><td class="tg-8jgo">Milliseconds</td><td class="tg-ofj5">ms</td><td class="tg-ofj5">10<sup>-3</sup></td></tr><tr><td class="tg-8jgo">Microseconds</td><td class="tg-ofj5">Î¼s</td><td class="tg-ofj5">10<sup>-6</sup></td></tr><tr><td class="tg-8jgo">Nanoseconds</td><td class="tg-ofj5">ns</td><td class="tg-ofj5">10<sup>-9</sup></td></tr></tbody></table></div></div><style>.left_bar .kbd_shortcuts{color:#000;font-size:16px;line-height:1.55;list-style-type:none;position:relative}.left_bar .kbd_shortcuts kbd{font-size:14px}.left_bar .kbd_shortcuts .modal-content{position:relative;width:1200px;max-width:90%;height:max-content;max-height:90%;margin-top:55px;background-color:#cfdae4;overflow:auto}.left_bar .kbd_shortcuts .modal-body{margin:0;padding-bottom:12px;text-align:justify;padding-top:8px;padding-bottom:2px;overflow:visible;height:100%}.left_bar .kbd_shortcuts .modal-header{padding:0;color:#fff;width:100%}.left_bar .kbd_shortcuts .modal-header h2{padding-top:8px;font-size:20px;font-weight:700;width:100%;text-align:center;color:#fff;background-color:#3f6388}.left_bar .modalButton{border:none;box-shadow:none;width:auto;padding:0;background-color:transparent;color:#fff;margin:0}.left_bar .brmine{display:block;margin-bottom:.5em}</style></div></div></div></li><li style="text-transform:uppercase"><a href="/julia_book/links/"><img src="/julia_book/assets/icons/links.png" style="width:15%;height:auto;opacity:.9;padding-bottom:5px"> Links</a></li><li><a href="/julia_book/assets/pdf/juliaBook_Alfaro.pdf"><img src="/julia_book/assets/icons/icon_pdf.png" style="width:15%;height:auto;opacity:.9;padding-bottom:5px"> BOOK in PDF</a></li><li><h3 style="font-weight:400;font-size:14px;padding-top:2em;margin-bottom:-.5em;text-decoration:none">Dark Mode</h3><label class="switch"><input type="checkbox" id="toggleStyles"> <span class="slider round"></span></label></li></ul><div class="personal_website"><a href="https://alfaromartino.github.io"><img src="/julia_book/assets/icons/personal.png" style="width:18%;height:auto;opacity:.9;margin-bottom:-14px;padding-right:4px"> Personal<div style="margin-left:calc(30px + 2px);margin-top:-.5em">Website</div></a></div></div><style>@media (max-width:850px),(max-height:600px){.left_bar{display:none}}.left_bar{z-index:200;background-image:linear-gradient(to left bottom,#000,#000 10%,#3f6388 80%,#3f6388);position:fixed;font-family:Inter,"Open Sans";height:100%;top:0;left:0;font-size:20px;width:160px}.left_bar ul{list-style-type:none;float:left;font-size:80%;position:relative;padding-left:.8em;padding-top:40px;line-height:4.25em}.left_bar .personal_website a,.left_bar li a{color:#fff}.left_bar .personal_website a:hover,.left_bar a:hover{color:#a09f9f}.left_bar .personal_website{position:absolute;bottom:0;padding-bottom:1em;left:12px;font-size:20px;font-family:"Cormorant SC";font-weight:700}</style><style>.switch{position:relative;display:inline-block;width:30px;height:17px}.switch input{display:none}.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s}.slider:before{position:absolute;content:"";height:13px;width:13px;left:2px;bottom:2px;background-color:#fff;transition:.4s}input:checked+.slider{background-color:#000}input:checked+.slider:before{transform:translateX(13px)}.slider.round{border-radius:17px}.slider.round:before{border-radius:50%}html.dark-mode{background-color:#030911!important}html.dark-mode .franklin-content,html.dark-mode .modal-body{background-color:#030911!important}html.dark-mode .franklin-content section,html.dark-mode .index_container,html.dark-mode .modal-content{color:#ebf4fc!important}html.dark-mode .index_container,html.dark-mode .index_container h1{background-color:#030d18!important}html.dark-mode .index_container ul>li{color:#ebf4fc!important}html.dark-mode .index_container a{color:#588cc0}html.dark-mode .index_container a:hover,html.dark-mode h2:hover,html.dark-mode section a:hover{color:#bed5ec}html.dark-mode .multiple_pics{background-color:#4b6d92}html.dark-mode .multiple_pics h2{color:#fff!important}html.dark-mode .note,html.dark-mode .warning{color:#000}html.dark-mode .code_box,html.dark-mode .code_in_modal,html.dark-mode .img_output_in_modal,html.dark-mode .output_in_modal{border-width:1px;border-style:solid;border-color:rgba(0,44,82,.99)}html.dark-mode .tab_wrapper .tab_code_links .tablink.active{background-color:rgba(94,140,185,.95)}html.dark-mode .tab_wrapper .tab_code_links .tablink:hover{background-color:rgba(94,140,185,.95)}html.dark-mode .bar_top,html.dark-mode .nav-menu.show,html.dark-mode nav .nav-toggle{background-image:linear-gradient(to top,#122030,#122030 60%)!important}html.dark-mode .bar_top .modal-body,html.dark-mode .bar_top .modal-content,html.dark-mode .bar_top .modal-header{background-image:linear-gradient(to top,#122030,#122030 60%)!important}html.dark-mode header .jumbotron{background-image:linear-gradient(to bottom,#122030,#122030 50%)!important}html.dark-mode .left_bar{background-image:linear-gradient(to left bottom,#122030,#122030 10%)}html.dark-mode footer{background-image:linear-gradient(to right,#122030,#000 10%)!important;border-top:1px solid rgba(0,44,82,.99);background-color:rgba(63,99,136,.3);width:calc(100%+10px);margin-left:0;padding-left:10px}html.dark-mode .left_bar .kbd_shortcuts .modal-content{background-color:#000!important}</style><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("toggleStyles"),t=document.documentElement;"enabled"===localStorage.getItem("darkMode")&&(e.checked=!0),e.addEventListener("change",function(){this.checked?(t.classList.add("dark-mode"),localStorage.setItem("darkMode","enabled")):(t.classList.remove("dark-mode"),localStorage.setItem("darkMode","disabled"))})})</script><header class="text-white text-center"><div class="jumbotron jumbotron-fluid container-fluid bg-primary"><h1><i>9g.</i> Lazy Broadcasting and Loop Fusion</h1><div class="lead"></div><div class="name_format"><a href="https://alfaromartino.github.io/" target="_blank" rel="noopener noreferrer">Martin Alfaro</a></div><div class="phd_format">PhD in Economics</div></div></header><link href="https://fonts.cdnfonts.com/css/cascadia-mono" rel="stylesheet"><style>pre{position:relative;overflow:hidden}code{background-color:#d1d9e0;color:#000;text-indent:0;padding-top:.1em;padding-bottom:.1em;padding-left:.3em;padding-right:.3em;vertical-align:.05em;border:1px solid #001029;overflow:hidden}.julia_repl_NoFormat code,.mixed_output_NoFormat code{background-color:#527868;color:#dcdcdc;border:1px solid #527868}.copy-button{cursor:pointer;border:none;font-size:12px;text-transform:lowercase;font-weight:500;padding:2px 10px 2px;background-color:#3f6388;position:absolute;top:0;right:12px;text-align:center;color:#fff;margin-top:0;z-index:1}.copy-button:hover{outline:0;background-color:#5483b3}.copy-button:focus{outline:0;background-color:#324e6b}.julia_line{color:#20c679!important;font-weight:700;display:inline;font-size:100%}.julia_repl_NoFormat{font-size:87%}.julia_repl_NoFormat .julia_line,.julia_repl_NoFormat code{font-size:100%}.mixed_output_NoFormat{font-size:87%}.mixed_output_NoFormat .julia_line,.mixed_output_NoFormat code,.mixed_output_NoFormat pre{font-size:100%}.akin_to_pre{white-space:pre-wrap;font-family:Consolas,monospace}.julia_repl_NoFormat{font-family:Consolas,monospace;color:#dcdcdc;border:none;background-color:#013b1f;margin:0;padding:0}.julia_repl_NoFormat .akin_to_pre{line-height:1.35;color:#dcdcdc;margin:0;padding:0}.franklin_output_NoFormat{font-family:Consolas,monospace;margin:0;padding:0;background-color:#013b1f}.franklin_output_NoFormat pre{margin:0;padding:0;line-height:1.35;background-color:#013b1f}.franklin_output_NoFormat pre code{margin:0!important;padding:0!important;border:none;background-color:#013b1f}.mixed_output_NoFormat{font-family:Consolas,monospace;color:#dcdcdc;border:none;background-color:#013b1f;margin:0;padding:0}.mixed_output_NoFormat pre{line-height:1.35;color:#dcdcdc;margin:0;padding:0}.mixed_output_NoFormat pre code{margin:0!important;padding:0!important;border:none;background-color:#013b1f}.mixed_output_inline{color:#dcdcdc;font-family:Consolas,monospace;background-color:#013b1f;padding-left:1em;padding-top:.5em;padding-bottom:1em;margin-top:0;margin-bottom:0}.output_box{margin:0;padding:0}.output_box details>summary{width:max-content;max-width:90%;padding-left:10px;padding-right:10px;background-color:#3f6b4b;cursor:pointer;color:#fff;box-shadow:3px 3px 4px #000;text-indent:0}.output_box details[open]>summary{width:max-content;max-width:90%;padding-left:10px;padding-right:10px;background-color:#3f6b4b;border:#282c34;border-width:1px;border-style:solid}.output_box{padding-top:.5em;padding-bottom:1em;margin-top:0;margin-bottom:1em}.code_NoFormat{line-height:1.45;margin:0;padding:0;background-color:#001029}.code_NoFormat pre{margin:0;padding:0;background-color:#001029}.code_NoFormat pre code{font-family:"Cascadia Mono",monospace;margin:0!important;padding:0!important;border:none;background-color:#001029}.code_NoFormat p{padding:0;margin:0}.code_inline{background-color:#001029;padding-left:1em;padding-top:.5em;padding-bottom:1em;margin-top:0;margin-bottom:0}.code_box{margin:0;padding:0}.code_box details>summary{width:max-content;max-width:90%;padding-left:10px;padding-right:10px;background-color:#3f6388;cursor:pointer;color:#fff;box-shadow:3px 3px 4px #000;text-indent:0}.code_box details[open]>summary{width:max-content;max-width:90%;padding-left:10px;padding-right:10px;background-color:#3f6388;border:#282c34;border-width:1px;border-style:solid}.code_box{padding-top:0;padding-bottom:0;margin-top:0;margin-bottom:1em}.hide_tab{padding-top:0;padding-bottom:0;margin-top:0;margin-bottom:1em}.hide_tab>details>summary{max-width:100%;min-width:30px;width:fit-content;padding-left:11px;padding-right:0;padding-bottom:0;background-color:#3f6388;cursor:pointer;color:#fff;text-indent:0;border:#282c34;border-width:1px;border-style:solid}.hide_tab>details[open]>summary .closed_text{display:none}.hide_tab>details>summary .closed_text{padding-left:1em;padding-right:1em;margin-left:.25em;display:inline-block;border-left:#282c34;border-width:1px;border-style:solid;border-bottom:none;border-top:none;border-right:none}.hide_tab>details[open]>summary{position:absolute;width:35px;max-width:90%;height:1.94em;padding-bottom:0;padding-top:3px;padding-left:12px;padding-right:5px;background-color:#3f6388;border:#282c34;border-width:1px;border-style:solid;border-bottom:none}.tab_wrapper{width:100%;display:inline-block}.tab_wrapper .tab_code_links{background-color:#001029}.tab_wrapper .tab_code_links .tablink{background-color:#3f6388;color:#fff;float:left;border:1px solid #000;outline:0;cursor:pointer;padding:2px 20px;width:max-content;height:auto}.tab_wrapper .tab_code_links .tablink.first_tab{padding-left:54px}.tab_wrapper .tab_code_links .tablink.active{font-weight:500;background-color:rgba(82,127,173,.836)}.tab_wrapper .tab_code_links .tablink:hover{background-color:rgba(82,127,173,.836)}.tab_wrapper .tabcontent{background-color:#001029;display:none;width:100%;float:left;margin:0;padding:0}.tab_wrapper .tabcontent.active{display:block}.code_in_modal{background-color:#001029;padding-left:1em;padding-top:.5em;padding-bottom:1em;margin-top:0;margin-bottom:0}.output_in_modal{background-color:#013b1f}.img_output,.img_output_in_modal{text-indent:0;margin:0;padding:0;background-color:#181818}.img_output_in_modal_old,.img_output_old{text-indent:0;margin:0;padding:0;background-color:#1e1e1e}.sign_output{color:#fff;width:100%;max-width:100%;height:auto;padding-bottom:0;padding-top:0;padding-left:12px;padding-right:12px;background-color:#3f6b4b;border:#282c34;border-width:1px;border-style:solid;margin-bottom:0;padding-top:0}.outputmodal_container{padding:0;margin:0}</style><style>.gif_output_in_modal{text-indent:0;margin:0;padding:0;background-color:#181818}.gif_output{position:relative;display:inline-block;cursor:pointer;margin:0;padding:0;max-width:100%}.gif-wrapper{display:block;visibility:hidden;margin:0;padding:0;max-width:100%}.gif-wrapper.playing{visibility:visible}.play-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background-color:#181818;background-color:#000;display:flex;justify-content:center;align-items:center}.play-overlay.hidden{background:0 0}.play-button{background:0 0;border:none;color:#fff;cursor:pointer;padding:0;transform:scale(.5);transition:background .3s}.play-overlay.hidden .play-button{display:none}</style><script>function setMaxHeight(){const e=document.querySelectorAll(".gif-wrapper");let t=0;e.forEach(e=>{const o=e.offsetHeight;o>t&&(t=o)}),e.forEach(e=>{e.style.height=`${t}px`,e.style.width="auto"})}document.addEventListener("DOMContentLoaded",function(){const e=document.querySelectorAll(".gif_output");let t=0;e.forEach(o=>{const n=o.querySelector(".gif-wrapper"),c=o.querySelector(".play-overlay");let l=!1;n.onload=function(){t++,t===e.length&&setMaxHeight()},o.addEventListener("click",function(){l?(n.classList.remove("playing"),c.classList.remove("hidden"),l=!1):(n.classList.add("playing"),c.classList.add("hidden"),l=!0)})})})</script><div class="bar_top"><ul><li><div style="text-indent:0"><button class="modalButton" id="openSearch" style="background-color:transparent;color:#fff;display:block;margin-bottom:-2px"><img src="/julia_book/assets/icons/search_icon.png" style="width:auto;height:30px;opacity:.9;padding-bottom:5px;margin-left:0;padding-right:0"> <span>Search</span></button></div><div class="searchBar" id="searchModal" style="display:none"><div class="modal"><div class="modal-content"><div class="modal-header"><h2>Search</h2></div><div class="modal-body"><div id="search_modal_container"></div></div></div></div></div></li></ul></div><style>.bar_top{padding-left:160px}.bar_top{background-image:linear-gradient(to right,#000,#000 10%,#3f6388 55%,#3f6388);position:fixed;width:100%;height:48px;top:0;left:0;padding:8px 0 10px 0;font-size:110%;z-index:125;font-family:Inter}.bar_top a:hover{color:#a09f9f}.bar_top>ul{list-style-type:none;float:left;position:relative;bottom:0;padding-left:1%;left:160px}.bar_top li a{color:#fff}.bar_top .modal{background-color:transparent;margin-top:48px;padding-left:1%;margin-left:0;width:100%;height:100%;overflow:auto;position:fixed}.bar_top .modal-content{position:relative;width:1200px;max-width:90%;height:max-content;max-height:90%;background-color:#000;margin:auto;padding:8px;margin-left:160px;-webkit-animation-name:none;animation-name:none}.bar_top .modal-header{background-color:#000;color:#fff}.bar_top .modal-body{color:#649dd6}.bar_top .modal-body .row{display:flex}.bar_top .modal-body .row .column{flex:1}.bar_top .modal-body .row h3{padding-bottom:.5em}.bar_top .modal-body .row ul li{line-height:1}.bar_top .modal-body .row ul li ul{list-style-type:none;margin:0;padding:0;padding-top:.5em;padding-bottom:.4em;line-height:1}.bar_top .modal-body .row ul li ul li{line-height:1}.bar_top .modal-body .row li{line-height:1;list-style-type:none;float:center;text-indent:-20px;padding-left:22px;position:relative}.bar_top .modal-body .row .column{text-align:center}.bar_top .modal-body .row .column h3{text-align:center}.bar_top .modal-body .row .column ul{text-align:left;margin-left:auto;margin-right:auto;list-style-position:inside;line-height:.55em}.bar_top .modalButton{border:none;margin-bottom:24px;box-shadow:none}.bar_top .modalClose{font-size:0px}</style><style>.footn{position:relative;display:inline-block;margin-left:-.6em;margin-right:0;color:#2669dd;text-decoration:underline}.supr{vertical-align:80%;font-size:75%;line-height:1}.footn .footn_text{font-size:125%;visibility:hidden;text-align:justify;text-justify:inter-word;text-indent:0;line-height:1.5;background-color:#282c34;color:#e0e4eb;border-radius:6px;padding:5px 12px 5px 12px;position:absolute;z-index:1;bottom:100%;right:0}.footn .footn_text.left{left:0;width:max-content;max-width:500px}.footn .footn_text.right{right:0;width:max-content;max-width:500px}.footn:hover .footn_text{visibility:visible}.footn a{color:#7b9fdd}.footn a:hover{color:#a1b6dbb2}</style><script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script><script>$(document).ready(function(){$(".footn.supr").hover(function(){var t=$(this).find(".footn_text"),e=$(this).closest("p"),o=e.width(),s=t.offset().left-e.offset().left>o/2;t.removeClass("left right"),s?t.addClass("right"):t.addClass("left"),t.addClass("hovering")},function(){$(this).find(".footn_text").removeClass("hovering"),$(this).find(".footn_text").removeClass("left right")})})</script><style>@media (max-width:768px){.footn .footn_text.left{left:0;width:max-content;max-width:200px}.footn .footn_text.right{right:0;width:max-content;max-width:200px}}</style><style>@media (max-width:850px){.jumbotron{font-size:90%!important}.franklin-content{font-size:100%!important}.franklin-content{padding-left:1%;padding-right:1%}.franklin-content .container{max-width:100%!important}.index_container,.index_container section{font-size:100%}.index_container{padding-left:1%;padding-right:1%}.index_container ul li{padding-right:5%;padding-left:0}.index_container ul{padding-right:0;padding-left:5%}.home_container section{font-size:100%;line-height:1.55em}.home_container ul li{padding-right:1%;padding-left:0}.home_container ul{padding-right:0;padding-left:0}.home_container .row li{padding-left:0;padding-bottom:1.55em;margin-left:0}.home_container .bullets_nomarker ul li p{line-height:1.55!important}.col-lg-.mx-auto{overflow:auto!important}.jumbotron{padding-left:60px!important;padding-right:1%!important;padding-top:0;margin-top:0}.modal{padding:2px!important}.bullets ol,.itemNoSpace ol{padding:4px}.bullets ul li,.itemNoSpace ul li{padding-right:5%;padding-left:0;margin-left:0}.bullets ul li p,.itemNoSpace ul li p{line-height:1.65}}@media (max-height:600px){.jumbotron{font-size:90%!important}.franklin-content{font-size:100%!important}.franklin-content .container{max-width:100%!important}.index_container,.index_container section{font-size:100%}.index_container ul li{padding-right:5%;padding-left:0}.index_container ul{padding-right:0;padding-left:5%}.index_container{padding-left:1%;padding-right:1%}.col-lg-.mx-auto{overflow:auto!important}.jumbotron{padding-left:60px!important;padding-right:1%!important;padding-top:0;margin-top:0}.franklin-content{padding-left:0!important}.modal{padding:2px!important}.bullets ol,.itemNoSpace ol{padding:6px}.bullets ul li,.itemNoSpace ul li{padding-right:5%;padding-left:0;margin-left:0}.bullets ul li p,.itemNoSpace ul li p{line-height:1.55}.index_container ul li{padding-right:5%;padding-left:0}.index_container ul{padding-right:0;padding-left:5%}}</style><div class="left_bar_mobile" style="color:#fff"><ul><li><a href="/julia_book/index.html"><img src="/julia_book/assets/icons/home.png" style="width:15%;height:auto;opacity:.9;padding-bottom:0"> HOME</a></li><li><a href="/julia_book/list_posts/"><img src="/julia_book/assets/icons/books03.png" style="width:15%;height:auto;opacity:.9;padding-bottom:0"> CHAPTERS</a></li><li><div class="dark-mode-mobile"><label class="switch"><input type="checkbox" class="toggleMobile"> <span class="slider round"></span></label></div></li></ul></div><style>@media (min-width:850px),(min-height:600px){.left_bar_mobile{display:none}}@media (max-width:850px),(max-height:600px){.left_bar_mobile{display:block}.left_bar_mobile img{display:none}.left_bar_mobile{z-index:200;background-image:none;position:absolute;font-family:Inter;height:160px!important;top:0;left:0;font-size:85% width : 60px}.left_bar_mobile ul{list-style-type:none;float:left;font-size:100%;position:relative;padding-left:.4em;padding-top:.2em;line-height:2em!important;height:100%;top:0;width:60px;display:flex;flex-direction:column;justify-content:space-around}.left_bar_mobile li{flex:1}.left_bar_mobile li a{color:#fff}.left_bar_mobile a:hover{color:#a09f9f}.dark-mode-mobile{position:relative;bottom:0;margin-top:auto}.dark-mode-mobile .switch{width:40px;height:20px}.dark-mode-mobile .slider:before{height:15px;width:15px}.dark-mode-mobile input:checked+.slider:before{transform:translateX(20px)}@media (max-width:850px),(max-height:600px){h2{font-size:140%;padding-top:1em}h1{font-size:180%;padding-top:.5em;padding-bottom:0}}}</style><style>@media (max-width:850px),(max-height:600px){.lead{display:none}.bar_top,.py-1 .container .center-text,nav{display:none!important}.jumbotron{padding-left:80px;padding-right:.1%!important;padding-top:0;margin-top:0}}</style><style>@media (min-width:850px),(min-height:600px){.dark-mode-mobile{visibility:hidden}}@media (max-width:850px),(max-height:600px){.dark-mode-mobile{visibility:visible}}</style><script>document.querySelector(".toggleMobile").addEventListener("change",function(){const e=document.documentElement;this.checked?(e.classList.add("dark-mode"),localStorage.setItem("darkMode","enabled")):(e.classList.remove("dark-mode"),localStorage.setItem("darkMode","disabled"))}),window.addEventListener("load",function(){const e=document.documentElement;"enabled"===localStorage.getItem("darkMode")?(document.querySelector(".toggleMobile").checked=!0,e.classList.add("dark-mode")):document.querySelector(".toggleMobile").checked=!1})</script><div class="franklin-content"><div class="note" style="width:62%" id="remarkCodeContent"><div class="title"><span class="note_title" style="font-weight:500"><img src="/julia_book/assets/icons/exclamation.png" style="width:auto;height:30px;opacity:.99;padding-bottom:4px;margin-left:-4px"> <b>Code Script</b></span></div><div class="content">The scripts of this section are available <a href="https://github.com/alfaromartino/julia_book/tree/main/assets/PAGES/09g_lazyBroadcasting/codeDownload"><strong>here</strong></a> under the name <code>allCode.jl</code>. They&#39;ve been tested under Julia 1.11.7.</div></div><div style="margin-bottom:-2em"></div><section id="introduction" class="scrollspy section-bg-color"><div class="container"><div class="row"><div class="col-lg- mx-auto"><h2>Introduction</h2><p></p><p>This section continues the analysis of lazy and eager operations as a means of reducing memory allocations. The focus now shifts to broadcasting operations, which strike a balance between code readability and performance.</p><p>A key feature of broadcasting is its eager default behavior. This means that broadcast operations compute and materialize outputs immediately upon execution. Thus, it inevitably leads to memory allocation when applied to objects such as vectors. Such behavior becomes especially relevant in scenarios with intermediate broadcast operations, whose allocations are potentially avoidable.</p><p>To address the associated performance cost, we&#39;ll present two strategies. The first one highlights the notion of <strong>loop fusion</strong>. This enables the combination of multiple broadcasting operations into a single more efficient one. Its relevance lies in minimizing memory allocations, rather than their entire elimination. After this, we&#39;ll explore the <code>LazyArrays</code> package, which evaluates broadcasting operations <a href="/julia_book/PAGES/09f_lazyOperations/">lazily</a>. When reductions require intermediate calculations, this technique can completely bypass memory allocations.</p><p></p></div></div></div></section><section id="how_does_broadcasting_work_internally" class="scrollspy"><div class="container"><div class="row"><div class="col-lg- mx-auto"><h2>How Does Broadcasting Work Internally?</h2><p></p><p>Under the hood, broadcasting operations are converted into optimized for-loops. Indeed, broadcasting is essentially syntactic sugar for for-loops, sparing developers from writing them explicitly. This makes it possible to write code that&#39;s concise and expressive, without sacrificing performance.</p><p>Despite this, you&#39;ll often notice performance differences in practice. These discrepancies stem primarily from compiler optimizations, rather than inherent differences between broadcasting and for-loops. The reason is that an operation supporting a broadcast form is automatically revealing additional information about its underlying structure. Consequently, the compiler is allowed to apply more aggressive optimizations. In contrast, for-loops are conceived as a general-purpose construct, precluding the compiler from automatically making such assumptions.</p><p>It&#39;s worth noting, though, that carefully optimized for-loops always match or exceed the performance of broadcasting. The following code snippets demonstrate this point. The first tab outlines the operation being performed, while the second tab provides a rough internal translation of broadcasting into a for-loop.</p><p>The third tab demonstrates the equivalence more directly, using a for-loop that resembles the broadcast code more closely. Its implementation adds the <code>@inbounds</code> macro, which broadcasting always applies automatically. The definition of <code>@inbounds</code> will be studied in <a href="/julia_book/PAGES/10b_macrosAlgorithms/#macros_applied_in_for-loops">a later section</a>. Its inclusion here is only to illustrate the internal implementation of broadcasting.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Broadcasting</button> <button class="tablink" data-id="">Rough Internal Implementation</button> <button class="tablink" data-id="">Actual Internal Implementation</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; 2 .* x</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  25.512 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output &#61; similar&#40;x&#41;

    for i in eachindex&#40;x&#41;
        output&#91;i&#93; &#61; 2 * x&#91;i&#93;
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  26.306 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output &#61; similar&#40;x&#41;

    @inbounds for i in eachindex&#40;x&#41;
        output&#91;i&#93; &#61; 2 * x&#91;i&#93;
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  27.366 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div></div><p></p></details></div><div class="warning"><div class="title"><span class="warning_title" style="font-weight:500"><img src="/julia_book/assets/icons/warning.png" style="width:auto;height:30px;opacity:.99;padding-bottom:4px;margin-left:-4px"> <b>Warning!</b> - About <code>@inbounds</code></span></div><div class="content">In the example provided, <code>@inbounds</code> <strong>was solely added to demonstrate the internal implementation of broadcasting, not as a general recommended practice</strong>. In fact, <code>@inbounds</code> <strong>can cause serious issues</strong> when used incorrectly.<p></p><p>To understand the role of this macro, recall that Julia performs bounds checks in for-loops by default. This means Julia verifies the existence of elements accessed during every iteration. Bounds checking prevents out-of-range access, so that a vector <code>x</code> with 3 elements isn&#39;t accessed at index <code>x&#91;4&#93;</code>. Instead, placing <code>@inbounds</code> at the beginning of a for-loop instructs Julia to disable these checks.</p><p>Removing bounds checking can improve performance, but it comes at the cost of safety: an out-of-range access may result in program termination or trigger more severe issues. Out-of-bounds access can&#39;t occur when operations support broadcasting, since the broadcast mechanism guarantees a valid index range. Consequently, Julia safely omits these checks by automatically applying <code>@inbounds</code>.</p></div></div><div style="text-indent:0"><button class="modalButton"><strong>REMARK (OPTIONAL)</strong> Other Optimization Differences Between Broadcasting and For-Loops</button></div><div class="modal"><div class="modal-content"><div class="modal-header"><span class="modalClose">&times;</span><h2><strong>REMARK (OPTIONAL)</strong> Other Optimization Differences Between Broadcasting and For-Loops</h2></div><div class="modal-body"><p>We shouldn&#39;t infer from the previous example that the compiler disregards the structure of for-loops, thereby missing opportunities for further optimizations. In fact, the compiler may automatically insert <code>@inbounds</code> in for-loops when it&#39;s safe to do so. This typically occurs in simple cases, such as when only <code>x</code> is indexed and the iteration range is given by <code>eachindex&#40;x&#41;</code>. In the previous example, <code>@inbounds</code> wasn&#39;t automatically applied because <code>output</code> was also being iterated.</p><p></p><div style="height:23em"><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">For-Loop</button> <button class="tablink" data-id="">For-Loop @inbounds</button></div><div data-id="" class="tabcontent active"><div class="code_inline"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output &#61; zero&#40;eltype&#40;x&#41;&#41;

    for i in eachindex&#40;x&#41;
        output &#43;&#61; 2 * x&#91;i&#93;
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  24.463 ns (0 allocations: 0 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_inline"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output &#61; zero&#40;eltype&#40;x&#41;&#41;

    @inbounds for i in eachindex&#40;x&#41;
        output &#43;&#61; 2 * x&#91;i&#93;
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  24.345 ns (0 allocations: 0 bytes)
</code></pre></div></div></div></div></div><p></p></details></div></div><p></p><p><code>@inbounds</code> is just one example of how broadcasting and for-loops could differ. Indeed, compared to a plain for-loop, there are other optimizations that broadcasting automatically applies to enhance performance.</p><p>One such optimization is the detection of operations that remain invariant across iterations. In such cases, broadcasting will hoist the operation out of the for-loop, computing it once and then reusing the same result. Instead, a for-loop will recompute the operation during every iteration, unless explicitly instructed otherwise. A typical example is when normalizing the values of <code>x</code>, so that their sum equals unity. Broadcasting will then compute <code>sum&#40;x&#41;</code> only once, while a for-loop will recompute it at every iteration.</p><p></p><div style="height:24em"><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Broadcasting</button> <button class="tablink" data-id="">For-Loop (Equivalent)</button> <button class="tablink" data-id="">For-Loop (Slower)</button></div><div data-id="" class="tabcontent active"><div class="code_inline" style="padding-bottom:12.4em"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; x ./ sum&#40;x&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  41.022 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_inline"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output      &#61; similar&#40;x&#41;
    denominator &#61; sum&#40;x&#41;

    @inbounds for i in eachindex&#40;x&#41;
        output&#91;i&#93; &#61; x&#91;i&#93; / denominator
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  41.830 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_inline"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    output      &#61; similar&#40;x&#41;
    

    for i in eachindex&#40;x&#41;
        output&#91;i&#93; &#61; x&#91;i&#93; / sum&#40;x&#41;
    end

    return output
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  597.074 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div></div><p></p></details></div></div><p></p></div></div></div><h4>Consequences of How Broadcasting is Internally Computed</h4><p>Once we understand how broadcasting is computed internally, we can also anticipate its consequences for memory allocations. First, broadcasting involves the creation of a collection like <code>output</code> to store the result. Therefore, the operation will necessarily allocate when broadcasting vectors, since <code>output</code> will inherit the type of its inputs.</p><p>Importantly, <strong>memory allocations in broadcasting arise even when the result isn't explicitly stored</strong>. For example, evaluating <code>sum&#40;2 .* x&#41;</code> involves storing internally the intermediate output <code>2 .* x</code>.</p><p>Second, Julia&#39;s broadcasting is eager by default. Continuing with the same example, this means that <code>2 .* x</code> in <code>sum&#40;2 .* x&#41;</code> is computed immediately. As we&#39;ll see, adopting a lazy strategy can be advantageous in such cases. By deferring the computation of <code>2 .* x</code> until <code>sum&#40;2 .* x&#41;</code> is executed, we let Julia know that the broadcast operation will be used as part of a reduction. Thus, the compiler can optimize the internal computation, by generating a for-loop that reduces a transformed version of <code>x</code>. This avoids materializing the intermediate result altogether, thereby eliminating the temporary allocation for <code>2 .* x</code>.</p><p></p></div></div></div></section><section id="loop_fusion" class="scrollspy section-bg-color"><div class="container"><div class="row"><div class="col-lg- mx-auto"><h2>Loop Fusion</h2><p></p><p>When working with long broadcast operations, splitting them into smaller intermediate steps can significantly improve readability and reduce the likelihood of errors. However, this approach comes at the cost of separately allocating each broadcasting operation.</p><p>To mitigate unnecessary memory allocations, it&#39;s essential to preserve <span style="color:#3e79b4"><strong>loop fusion</strong></span>: a compiler optimization that merges multiple element-wise operations into a single loop over the data. Thus, with loop fusion enabled, the compiler can perform all operations in a single pass over the data. This not only eliminates the creation of multiple intermediate vectors, but also provides the compiler with a holistic view of the operations, thus unlocking further optimizations.</p><p>Loop fusion is applied automatically when all operations are expressed as a single broadcast operation. Yet, as indicated before, writing a single lengthy monolithic expression is inconvenient for complex computations. To overcome this limitation, we can rely on the lazy design of function definitions. Below, we show how this approach can break down an operation into partial calculations, while still preserving loop fusion.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Operation Splitted</button> <button class="tablink" data-id="">Loop Fusion</button> <button class="tablink" data-id="">Splitting Operation While Ensuring Loop Fusion</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    a      &#61; x .* 2
    b      &#61; x .* 3
    
    output &#61; a .&#43; b
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  82.627 ns (6 allocations: 2.719 KiB)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; rand&#40;100&#41;

foo&#40;x&#41;   &#61; x .* 2 .&#43; x .* 3     # or @. x * 2 &#43; x * 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  26.787 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; rand&#40;100&#41;

term1&#40;a&#41; &#61; a * 2
term2&#40;a&#41; &#61; a * 3

foo&#40;a&#41;   &#61; term1&#40;a&#41; &#43; term2&#40;a&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo.&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  27.222 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div></div><p></p></details></div><p>Even with a single simple operation, certain coding patterns can inadvertently break loop fusion. When this occurs, Julia will internally fall back to evaluating sub-expressions in separate for-loops, which are eventually combined to present the final output. In the following, we present two of these cases. The key practical takeaway is that you should broadcast via the macro <code>@.</code> when possible, rather than manually adding dots to each operator and function within an expression.</p><h4>Mixing Broadcasting with Vector Operations Breaks Loop Fusion</h4><p>To understand the issue, there are two facts to consider. The first one is that some vector operations produce an equivalent result to their broadcast counterparts. For instance, adding two vectors with <code>&#43;</code> yields the same result as summing them element-wise with <code>.&#43;</code>.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Broadcasting</button> <button class="tablink" data-id="">Vector Operation</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; &#91;1, 2, 3&#93;
y        &#61; &#91;4, 5, 6&#93;

foo&#40;x,y&#41; &#61; x .&#43; y</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>foo&#40;x,y&#41;</code><br><pre><code class="plaintext code-output">3-element Vector{Int64}:
 5
 7
 9</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; &#91;1, 2, 3&#93;
y        &#61; &#91;4, 5, 6&#93;

foo&#40;x,y&#41; &#61; x &#43; y</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>foo&#40;x,y&#41;</code><br><pre><code class="plaintext code-output">3-element Vector{Int64}:
 5
 7
 9</code></pre></div></div></div></div></div><p></p></details></div><p>Another example is with product operations.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Broadcasting</button> <button class="tablink" data-id="">Vector Operation</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; &#91;1, 2, 3&#93;
Î²        &#61; 2

foo&#40;x,Î²&#41; &#61; x .* Î²</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>foo&#40;x,Î²&#41;</code><br><pre><code class="plaintext code-output">3-element Vector{Int64}:
 2
 4
 6</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x        &#61; &#91;1, 2, 3&#93;
Î²        &#61; 2

foo&#40;x,Î²&#41; &#61; x * Î²</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>foo&#40;x,Î²&#41;</code><br><pre><code class="plaintext code-output">3-element Vector{Int64}:
 2
 4
 6</code></pre></div></div></div></div></div><p></p></details></div><p>The second fact to consider is that vector operations don&#39;t participate in loop fusion. Thus, even if all these operations were combined into a single expression, Julia will evaluate each sub-expression separately, allocating temporary vectors at every step.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Vector Operation</button> <button class="tablink" data-id="">Internal Implementation</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x &#61; rand&#40;100&#41;

foo&#40;x&#41;  &#61; x * 2 &#43; x * 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  84.459 ns (6 allocations: 2.719 KiB)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x &#61; rand&#40;100&#41;

function foo&#40;x&#41; 
    term1  &#61; x * 2        
    term2  &#61; x * 3
    
    output &#61; term1 &#43; term2
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  87.042 ns (6 allocations: 2.719 KiB)
</code></pre></div></div></div></div></div><p></p></details></div><p>Putting both facts together, mixing broadcasting with vector operations in the same expression may yield the correct result, but only achieve loop fusion partially. This means Julia will only fuse contiguous broadcast segments, internally partitioning the computation into separate for-loops when a vector operation is encountered. Each of these for-loops will produce a temporary intermediate vector.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Partial Fusion</button> <button class="tablink" data-id="">Internal Implementation</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; x * 2 .&#43; x .* 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  67.221 ns (4 allocations: 1.812 KiB)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

function foo&#40;x&#41;
    term1  &#61; x * 2
    
    output &#61; term1 .&#43; x .*3
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  64.923 ns (4 allocations: 1.812 KiB)
</code></pre></div></div></div></div></div><p></p></details></div><p>This behavior leads to a clear and actionable guideline: for full loop fusion, every operator and function in the expression must be explicitly broadcast. Yet manually adding dots throughout a large expression is both tedious and error-prone: one missing dot is enough to reintroduce unnecessary allocations. There are two coding practices that mitigate this risk.</p><p>One option is to broadcast via the macro <code>@.</code>, as shown below in the tab &quot;Equivalent 1&quot;. By design, this adds a dot to <em>all</em> operators and functions within an expression, guaranteeing loop fusion. An alternative is to express the operation through a <em>scalar</em> function, which we then broadcast. This is presented below in the tab &quot;Equivalent 2&quot;.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Loop Fusion</button> <button class="tablink" data-id="">Equivalent 1</button> <button class="tablink" data-id="">Equivalent 2</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; x .* 2 .&#43; x .* 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  28.810 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; @. x * 2 &#43; x * 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  28.215 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x      &#61; rand&#40;100&#41;

foo&#40;a&#41; &#61; a * 2 &#43; a * 3</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo.&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  27.936 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div></div><p></p></details></div><p></p></div></div></div></section><section id="lazy_broadcasting" class="scrollspy"><div class="container"><div class="row"><div class="col-lg- mx-auto"><h2>Lazy Broadcasting</h2><p></p><p>Broadcasting results in memory allocations since the technique is eager by default. This property means that its output becomes readily available when a broadcast expression is evaluated. Considering this, another way to achieve loop fusion is by evaluating all broadcast sub-expressions lazily, until the final output is computed. The approach is similar in spirit to the use of helper functions to accomplish the same goal, but without cluttering the namespace with new functions.</p><p>The functionality is provided by the macro <code>@~</code> from the <code>LazyArrays</code> package. By prepending this macro to the broadcasting operation, its computation is deferred until its output is required.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Eager Broadcasting</button> <button class="tablink" data-id="">Lazy Broadcasting @~</button> <button class="tablink" data-id="">Splitting Operations with Functions</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x         &#61; rand&#40;100&#41;

function foo&#40;x&#41; 
    term1  &#61; x .* 2
    term2  &#61; x .* 3
    
    output &#61; term1 .&#43; term2
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  90.883 ns (6 allocations: 2.719 KiB)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x         &#61; rand&#40;100&#41;

function foo&#40;x&#41; 
    term1  &#61; @~ x .* 2
    term2  &#61; @~ x .* 3
    
    output &#61; term1 .&#43; term2
end</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  26.362 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x         &#61; rand&#40;100&#41;

term1&#40;a&#41;  &#61; a * 2
term2&#40;a&#41;  &#61; a * 3

foo&#40;a&#41;    &#61; term1&#40;a&#41; &#43; term2&#40;a&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  28.451 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div></div><p></p></details></div><p>Beyond this resemblance with an approach based on functions, lazy broadcasting additionally addresses certain scenarios that functions can&#39;t handle. To understand this, note that the operations explored thus far resulted in a <em>vector</em> output. In those cases, memory allocations could at best be reduced to a single unavoidable allocation, necessary for storing the final output.</p><p>When the final output is instead given by a scalar, as occurs with reductions, lazy broadcasting is capable of entirely eliminating memory allocations. The reason is that lazy broadcasting fuses with reduction operations, letting the compiler apply a <a href="&#40;/PAGES/09e_reductions/#avoiding_memory_allocations_through_reductions&#41;">non-allocating procedure</a>. This is illustrated in the example below.</p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Eager Broadcasting</button> <button class="tablink" data-id="">Lazy Broadcasting</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia"># eager broadcasting &#40;default&#41;
x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; sum&#40;2 .* x&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  42.069 ns (2 allocations: 928 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">using LazyArrays
x      &#61; rand&#40;100&#41;

foo&#40;x&#41; &#61; sum&#40;@~ 2 .* x&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  7.360 ns (0 allocations: 0 bytes)
</code></pre></div></div></div></div></div><p></p></details></div><div class="note"><div class="title"><span class="note_title" style="font-weight:500"><img src="/julia_book/assets/icons/exclamation.png" style="width:auto;height:30px;opacity:.99;padding-bottom:4px;margin-left:-4px;padding-right:.4em"><strong>Lazy Broadcasting May Be Faster Than Other Lazy Alternatives</strong></span></div><div class="content">An additional advantage of <code>@~</code> is that it implements extra optimizations. This explains why <code>@~</code> tends to be faster than alternatives like a lazy map, even though neither allocates memory. This performance benefit can be noticed in the following comparison.<p></p><p></p><div class="hide_tab"><details open><summary><div class="closed_text"></div></summary><p></p><div class="tab_wrapper"><div class="tab_code_links"><button class="tablink first_tab active" data-id="">Lazy Broadcasting @~</button> <button class="tablink" data-id="">Lazy Map</button></div><div data-id="" class="tabcontent active"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x &#61; rand&#40;100&#41;

term1&#40;a&#41; &#61; a * 2
term2&#40;a&#41; &#61; a * 3
temp&#40;a&#41;  &#61; term1&#40;a&#41; &#43; term2&#40;a&#41;

foo&#40;x&#41;   &#61; sum&#40;@~ temp.&#40;x&#41;&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  10.940 ns (0 allocations: 0 bytes)
</code></pre></div></div></div></div><div data-id="" class="tabcontent"><div class="code_in_modal"><div class="code_NoFormat"><pre><code class="language-julia">x &#61; rand&#40;100&#41;

term1&#40;a&#41; &#61; a * 2
term2&#40;a&#41; &#61; a * 3
temp&#40;a&#41;  &#61; term1&#40;a&#41; &#43; term2&#40;a&#41;

foo&#40;x&#41;   &#61; sum&#40;Iterators.map&#40;temp, x&#41;&#41;</code></pre></div></div><div class="output_in_modal"><div class="sign_output">Output in REPL</div><div class="mixed_output_inline"><div class="mixed_output_NoFormat"><div class="julia_line">julia&gt</div><code>@btime foo&#40;&#36;x&#41;</code><br><pre><code class="plaintext code-output">  29.170 ns (0 allocations: 0 bytes)
</code></pre></div></div></div></div></div><p></p></details></div></div></div><p></p></div></div></div></section><footer class="py-1"><div class="container"><span class="left-text"><a href="/julia_book/PAGES/09f_lazyOperations" class="prevPage"><img src="/julia_book/assets/icons/prev-page.png" style="width:50px;height:auto;opacity:.9;padding-bottom:5px"> Previous Section <span class="ctrl-text">( <kbd>Ctrl + <img src="/julia_book/assets/icons/arrow_left.png" style="width:15px;height:auto;opacity:.9;padding-bottom:2px"> </kbd>)</span> </a></span><span class="right-text"><a href="/julia_book/PAGES/09h_preallocations" class="nextPage">Next Section <span class="ctrl-text">( <kbd>Ctrl + <img src="/julia_book/assets/icons/arrow_right.png" style="width:15px;height:auto;opacity:.9;padding-bottom:2px"> </kbd>)</span> <img src="/julia_book/assets/icons/next-page.png" style="width:50px;height:auto;opacity:.9;padding-bottom:5px"> </a></span><span class="center-text">Â© Martin Alfaro<br>Last Modified December 15, 2025</span></div></footer><style>@media (max-width:850px),(max-height:600px){.ctrl-text{display:none}}footer{font-family:Inter}footer .container{width:100%;margin-top:.6em;margin-bottom:.5em;overflow:hidden;text-align:center;align-items:center;justify-content:center;color:#fff}footer .center-text{text-align:center}footer .left-text{float:left}footer .right-text{float:right}footer a{color:#fff}footer a:hover{color:#fff;opacity:.9;text-decoration:none}</style><script>const prevPageURL=document.querySelector(".prevPage").href,nextPageURL=document.querySelector(".nextPage").href;function goToPrevPage(){window.location=prevPageURL}function goToNextPage(){window.location=nextPageURL}document.querySelector(".prevPage").addEventListener("click",goToPrevPage),document.querySelector(".nextPage").addEventListener("click",goToNextPage),document.addEventListener("keyup",e=>{"ArrowLeft"===e.key&&e.ctrlKey?goToPrevPage():"ArrowRight"===e.key&&e.ctrlKey&&goToNextPage()})</script></div><script src="/julia_book/libs/katex/katex.min.js"></script><script src="/julia_book/libs/katex/auto-render.min.js"></script><script>renderMathInElement(document.body)</script><script src="/julia_book/libs/highlight/highlight.js"></script><script>hljs.highlightAll(),hljs.configure({tabReplace:"    "})</script><script src="/julia_book/libs/simple-scrollspy.min.js"></script><script>window.onload=function(){scrollSpy("#navbarResponsive",{sectionClass:".scrollspy",menuActiveTarget:".nav-link",offset:100})}</script></body></html><!-- 
#################################################
# FOR ALL PAGES
################################################# 
--><script>const btns=document.getElementsByClassName("modalButton"),modals=document.getElementsByClassName("modal");[...btns].forEach((e,t)=>{e.onclick=()=>{"block"===modals[t].style.display?modals[t].style.display="none":modals[t].style.display="block"}}),window.addEventListener("click",function(e){const t=document.getElementsByClassName("modal"),l=document.getElementsByClassName("modal-content"),n=document.getElementsByClassName("modalButton");for(let s=0;s<t.length;s++){const o=t[s],a=l[s],d=n[s];"block"!==o.style.display||a.contains(e.target)||d.contains(e.target)||(o.style.display="none")}}),document.addEventListener("keydown",function(e){if(e.ctrlKey&&"z"===e.key){const e=document.getElementById("modal_bar");e&&"block"===e.style.display?e.style.display="none":e.style.display="block"}})</script><script>let handleClick=e=>{Array.from(e.target.parentElement.parentElement.querySelectorAll(".active"),e=>e.classList.remove("active")),e.target.classList.add("active"),document.querySelector(`div.tabcontent[data-id*="${e.target.dataset.id}"]`).classList.add("active")};Array.from(document.getElementsByClassName("tablink"),e=>e.addEventListener("click",handleClick,!1))</script><script>let setHeight=()=>{document.querySelectorAll(".tab_wrapper").forEach(e=>{let t=e.querySelectorAll(".tabcontent"),i=0,l=0;t.forEach(e=>{let t=e.style.visibility;e.style.visibility="visible";let o=e.style.position,s=e.style.display;e.style.position="relative",e.style.display="inline-block";let y=e.querySelector(".code_in_modal"),r=e.querySelector(".output_in_modal");if(y){y.style.height="auto";let e=y.offsetHeight;e>i&&(i=e)}if(r){r.style.height="auto";let e=r.offsetHeight;e>l&&(l=e)}e.style.visibility=t,e.style.position=o,e.style.display=s}),t.forEach(e=>{let t=e.querySelector(".code_in_modal"),o=e.querySelector(".output_in_modal");t&&(t.style.height=i+"px"),o&&(o.style.height=l+"px")})})};window.addEventListener("load",setHeight),window.addEventListener("resize",setHeight)</script><script>for(var tabWrappers=document.getElementsByClassName("tab_wrapper"),i=0;i<tabWrappers.length;i++)for(var tabWrapper=tabWrappers[i],buttons=tabWrapper.getElementsByClassName("tablink"),tabContents=tabWrapper.getElementsByClassName("tabcontent"),j=0;j<buttons.length;j++){var button=buttons[j],tabContent=tabContents[j],dataId="tab"+(i+1)+"_"+(j+1);button.setAttribute("data-id",dataId),tabContent.setAttribute("data-id",dataId)}</script><script>document.addEventListener("keydown",function(e){if("ArrowUp"===e.code&&e.altKey)for(var n=document.getElementsByTagName("details"),t=0;t<n.length;t++)n[t].open=!1})</script><script>document.addEventListener("keydown",function(e){if("ArrowDown"===e.code&&e.altKey)for(var n=document.getElementsByTagName("details"),o=0;o<n.length;o++)n[o].open=!0}),window.onkeydown=function(e){if("Escape"==e.key)for(let e of modals)e.style.display="none"}</script><style>.pic_drop_green{padding-top:1em;padding-bottom:1em}.pic_drop_green details>summary{color:#fff;display:inline-block;width:auto;cursor:pointer;padding:0 6px;margin:0;border-width:1px;border-style:solid;box-shadow:3px 3px 4px #000;background-color:#3f6b4b}.pic_drop_green details[open]>summary{width:auto;padding:0 6px;border:#a8a8a8;border-width:1px;border-style:solid;color:#fff;background-color:#3f6b4b}.pic_drop_green details>p{display:block;width:auto;padding:0;margin:0}.multiple_pics{text-align:center}.multiple_pics h2{text-decoration:none;padding-bottom:0}.multiple_pics .row{display:flex}.multiple_pics .column2{flex:50%}.multiple_pics .column3{flex:33.33%}</style><style>#search_modal_container .pagefind-ui__message,#search_modal_container .pagefind-ui__result-title,#search_modal_container p{display:block;width:100%!important;white-space:normal;text-indent:0}#search_modal_container .pagefind-ui__search-clear{font-size:100%}.bar_top .searchBar{display:flex;justify-content:center;width:auto}.bar_top .searchBar .modal-header{background-color:#3f6388}.bar_top .searchBar .modal-content{position:relative;width:auto;max-width:70%;height:max-content;max-height:90%;background-color:#cdd6e0;margin:auto;margin-left:160px;padding:8px;-webkit-animation-name:none;animation-name:none}.bar_top .searchBar .modal-body{padding:10px}#search_modal_container .pagefind-ui__result{margin:4px 0;padding:6px 8px}html.dark-mode #searchLine,html.dark-mode #search_modal_container{--pagefind-ui-text:rgb(235, 244, 252);--pagefind-ui-background:rgb(3, 9, 17);--pagefind-ui-placeholder:rgb(235, 244, 252);--pagefind-ui-border-radius:0px}html.dark-mode #searchLine ::placeholder,html.dark-mode #search_modal_container ::placeholder{opacity:.5}html.dark-mode #search_modal_container .pagefind-ui__button{color:rgba(235,244,252,.6)}#search_modal_container{--pagefind-ui-scale:0.9}#search_modal_container .pagefind-ui__search-clear{display:none}#search_modal_container .pagefind-ui__button{padding:0;height:auto}</style><script>let pagefind;window.addEventListener("DOMContentLoaded",()=>{pagefind=new PagefindUI({element:"#search_modal_container"})}),document.getElementById("openSearch").addEventListener("click",()=>{document.getElementById("searchModal").style.display="block",setTimeout(()=>{const e=document.querySelector("#search_modal_container input");e&&e.focus()},100)})</script><script>document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector("#search_modal_container");let t=-1;e.addEventListener("keydown",n=>{const r=e.querySelectorAll(".pagefind-ui__result a");r.length&&("ArrowDown"===n.key&&(n.preventDefault(),t=(t+1)%r.length,r[t].focus()),"ArrowUp"===n.key&&(n.preventDefault(),t=(t-1+r.length)%r.length,r[t].focus()),"Enter"===n.key&&t>=0&&(n.preventDefault(),r[t].click()))});new MutationObserver(()=>{t=-1}).observe(e,{childList:!0,subtree:!0})})</script><script>function generateId(e){return e.toLowerCase().replace(/[^\w\s]/g,"").replace(/\s+/g,"_")}function copyToClipboard(e){const t=document.createElement("input");document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)}function showTooltip(e,t,n="Link Copied"){const o=document.createElement("div");o.style.position="absolute";const l=document.createElement("span");l.textContent=n,l.style.position="absolute",l.style.background="rgba(63, 99, 136, 0.75)",l.style.color="white",l.style.padding="4px 2px",l.style.borderRadius="4px",l.style.fontSize="14px",l.style.textAlign="center",l.style.fontWeight="700",o.appendChild(l),t.appendChild(o);const i=t.getBoundingClientRect(),c=e.clientX-i.left-28,d=e.clientY-i.bottom-25;l.style.top=`${d}px`,l.style.left=`${c}px`,setTimeout(()=>{t.removeChild(o)},1e3)}function handleH2Elements(){document.querySelectorAll("h2").forEach(e=>{e.addEventListener("click",function(t){const n=e.textContent.trim();copyToClipboard(`${window.location.origin}${window.location.pathname}#${generateId(n)}`),showTooltip(t,e)})})}function handleH4Elements(){document.querySelectorAll("h4").forEach(e=>{const t=`sub_${generateId(e.textContent.trim())}`;e.setAttribute("id",t);const n=document.createElement("a");n.href=`#${t}`,n.innerHTML=e.innerHTML,n.style.textDecoration="underline",e.innerHTML="",e.appendChild(n),n.addEventListener("click",function(t){copyToClipboard(n.href),showTooltip(t,e),t.preventDefault()})})}document.addEventListener("DOMContentLoaded",function(){handleH2Elements(),handleH4Elements()})</script><style>h2,h4{cursor:pointer}.hand-cursor{cursor:wait}h2:hover,h4:hover{color:rgba(0,0,0,.5)}</style><!-- 
#################################################
# FOR EACH SPECIFIC PAGE
#################################################
 --><nav class="nav"><button class="nav-toggle" aria-label="Toggle navigation"><img src="/julia_book/assets/icons/dropdown.png" style="width:auto;height:30px;opacity:.9;padding-bottom:2px;margin-left:0"> <span class="nav-title"><i>9g.</i> Lazy Broadcasting and Loop Fusion</span></button><div class="nav-menu"><ul><li><a href="#introduction" data-offset="-40">Introduction</a></li><li><a href="#how_does_broadcasting_work_internally" data-offset="-40">How Does Broadcasting Work Internally?</a></li><li><a href="#loop_fusion" data-offset="-40">Loop Fusion</a></li><li><a href="#lazy_broadcasting" data-offset="-40">Lazy Broadcasting</a></li></ul></div></nav><script>const navToggle=document.querySelector(".nav-toggle"),navMenu=document.querySelector(".nav-menu"),navLinks=document.querySelectorAll(".nav-menu a");navToggle.addEventListener("click",()=>{navMenu.classList.toggle("show")}),navLinks.forEach(e=>{e.addEventListener("click",n=>{n.preventDefault();const t=document.querySelector(e.getAttribute("href")),o=parseInt(e.dataset.offset,10)||0;window.scrollTo({top:t.offsetTop+o,behavior:"smooth"})})}),document.addEventListener("click",e=>{navMenu.contains(e.target)||navToggle.contains(e.target)||navMenu.classList.remove("show")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&navMenu.classList.remove("show"),"x"===e.key&&e.ctrlKey&&navMenu.classList.toggle("show")})</script><style>.nav{position:fixed;top:0;right:0;z-index:200;background-color:#3f6388;padding:0;display:block;font-family:Inter}.nav-toggle{background-color:#3f6388;border:none;padding:8px;padding-right:24px;font-size:18px;cursor:pointer}.nav-menu{position:fixed;right:0;top:48px;background-color:#3f6388;padding:10px;width:300px;height:100vh;overflow-y:auto;display:none}.nav-menu ul{list-style:none;margin:0;padding:0}.nav-menu li{margin-bottom:10px}.nav-menu a{color:#fff;text-decoration:none;font-size:18px;font-weight:700;text-align:center;padding:10px 10px;display:block}.nav-menu a:hover{color:#fff;background-color:#000}.nav-title{font-size:18px;margin-left:10px;color:#fff}.nav-brand{font-size:24px;font-weight:700;margin:10px 20px;color:#fff}.nav-menu.show{display:block}</style><script src="/julia_book/libs/clipboard.min.js"></script><script>!function(){for(var t=document.getElementsByTagName("pre"),e=0;e<t.length;e++){var n=t[e].children[0].className;if(n.startsWith("language-")||n.endsWith(" hljs")){var o=document.createElement("button");o.className="copy-button",o.textContent="Copy",t[e].appendChild(o)}}var r=new Clipboard(".copy-button",{target:function(t){return t.previousElementSibling}});r.on("success",function(t){t.clearSelection(),t.trigger.textContent="copied!",window.setTimeout(function(){t.trigger.textContent="copy"},2e3)}),r.on("error",function(t){t.trigger.textContent='Press "Ctrl + C" to copy',window.setTimeout(function(){t.trigger.textContent="Copy"},5e3)})}()</script><style>@media print{.franklin-content{box-sizing:border-box}.jumbotron{padding-right:60px!important}.jumbotron,.name_format,.phd_format{color:#000!important}.name_format a{color:#3f6388}.hide_tab details[open] p,.hide_tab>details[open]>summary,.sign_output,.tab_code_links,nav{display:none!important}.bar_top,.bar_top .modalButton,.copy-button,.footn,.left_bar,.left_bar_mobile,.nav-item,.navbar,footer,nav{display:none!important}.tab_wrapper{display:flex!important;flex-wrap:wrap;gap:1cm;width:100%;padding-top:20px;padding-bottom:20px}.tabcontent{display:block!important;margin-bottom:2em;page-break-inside:avoid;border:2px solid #3f6388!important}.print-tab-title{font-weight:700;font-size:100%;padding:0 0;padding-left:.35cm;color:#000;text-transform:uppercase;display:block!important}.code_in_modal,.output_in_modal{width:100%;height:auto!important;overflow:visible;border:none!important}.code_NoFormat pre,.mixed_output_NoFormat pre{border:none!important}.code_NoFormat,.code_in_modal,.julia_repl_NoFormat,.mixed_output_NoFormat,.mixed_output_inline{margin:0!important;padding:0!important}.code_NoFormat,.julia_repl_NoFormat,.mixed_output_NoFormat{padding-left:.35cm!important;padding-top:.15cm!important}.output_in_modal{margin-top:12px!important;border-top:2px solid #20c679!important}.code_NoFormat,.code_in_modal{border-top:2px solid #3f6388}#remarkCodeContent{height:.1px!important;visibility:hidden!important}}</style><script>function printAllTabs(){const t=document.querySelectorAll(".tablink");document.querySelectorAll(".tabcontent").forEach((e,n)=>{const r=t[n].textContent.trim();if(!e.querySelector(".print-tab-title")){const t=document.createElement("div");t.className="print-tab-title",t.textContent=r,e.insertBefore(t,e.firstChild)}});for(var e=document.getElementsByTagName("a"),n=0;n<e.length;n++)e[n].removeAttribute("href"),e[n].style.textDecoration="none"}window.matchMedia("print").addListener(t=>{if(t.matches)printAllTabs();else{document.querySelectorAll(".tabcontent").forEach(t=>{const e=t.querySelector(".print-tab-title");e&&t.removeChild(e)})}})</script>